<div class="game-container">
  @if (!gameSession) {
    <div class="loading-message">Cargando mapa...</div>
  } @else {
    <div class="map-viewport" tabindex="0" #mapContainer>
      <div class="map-grid">
        @for (row of gameSession.map.tiles; track $index) {
          <div class="map-row">
            @for (tile of row; track tile.id) {
              <app-tile
                [tile]="tile"
                [isUnitSelected]="!!selectedUnit && selectedUnit.position.x === tile.x && selectedUnit.position.y === tile.y"
                [isPathTile]="isInPath(tile.x, tile.y)"
                [hasUnit]="hasUnitAt(tile.x, tile.y)"
                [unitCanMove]="canUnitAtTileMove(tile.x, tile.y)"
                [unitType]="getUnitTypeAt(tile.x, tile.y)"
                (tileClick)="onTileClick(tile)">
              </app-tile>
            }
          </div>
        }
      </div>
    </div>

    <!-- Panel de información de unidad seleccionada -->
    @if (selectedUnit) {
      <div class="info-panel unit-panel">
        <h3>{{ selectedUnit.name }}</h3>
        <p>Tipo: {{ selectedUnit.type }}</p>
        <p>Salud: {{ selectedUnit.health }}/{{ selectedUnit.maxHealth }}</p>
        <p>Movimiento: {{ selectedUnit.movementPoints }}/{{ selectedUnit.maxMovementPoints }}</p>

        <!-- Acción actual -->
        @if (selectedUnit.currentAction) {
          <div class="current-action">
            <p><strong>Acción actual:</strong> {{ getActionName(selectedUnit.currentAction) }}</p>
            @if (selectedUnit.turnsToComplete) {
              <p>Turnos restantes: {{ selectedUnit.turnsToComplete }}</p>
            }
          </div>
        }

        <!-- Acciones específicas por tipo de unidad -->
        <div class="action-buttons">
          @if (canUnitPerformAction(selectedUnit, 'found_city')) {
            <button (click)="performUnitAction('found_city')">
              Fundar Ciudad
            </button>
          }

          @if (canUnitPerformAction(selectedUnit, 'build_improvement')) {
            <button (click)="performUnitAction('build_improvement')">
              Construir Mejora
            </button>
          }

        </div>
      </div>
    }

    <!-- Vista de la ciudad al seleccionarla -->
    @if (selectedCity) {
      <app-city-view
        [city]="selectedCity"
        (close)="closeCity()"
        (production)="onCityProduction($event)">
      </app-city-view>
    }

    <!-- Diálogo para nombrar la ciudad -->
    @if (showFoundCityDialog) {
      <div class="city-dialog-overlay">
        <div class="city-dialog">
          <h3>Nombra tu nueva ciudad</h3>
          <input type="text" [(ngModel)]="cityName" placeholder="Nombre de la ciudad">
          <div class="dialog-buttons">
            <button (click)="cancelFoundCity()">Cancelar</button>
            <button (click)="confirmFoundCity()" [disabled]="!cityName">Fundar</button>
          </div>
        </div>
      </div>
    }

    <!-- Botón de fin de turno -->
    <button class="end-turn-button" (click)="finishTurn()">
      Fin de Turno
    </button>
  }
</div>
