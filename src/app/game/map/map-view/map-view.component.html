<div class="game-container">
  @if (!gameSession) {
    <div class="loading-message">Cargando mapa...</div>
  } @else {
    <div class="map-viewport" #mapContainer>
      <!-- Simple grid layout for the map -->
      <div class="map-grid">
        @for (row of gameSession.map.tiles; track $index) {
          <div class="map-row">
            @for (tile of row; track $index) {
              <app-tile
                [tile]="tile"
                [isHighlighted]="highlightedTile === tile"
                [isPathTile]="isInPath(tile.x, tile.y)"
                [isUnitSelected]="!!selectedUnit && selectedUnit.position.x === tile.x && selectedUnit.position.y === tile.y"
                (tileClick)="onTileClick(tile)">
              </app-tile>
            }
          </div>
        }
      </div>

      <!-- Units (displayed as text for simplicity) -->
      @for (unit of gameSession.units; track unit.id) {
        @if (isTileVisible(unit.position.x, unit.position.y)) {
          <div class="map-unit"
               [style.top.px]="(unit.position.y * 54) + 2"
               [style.left.px]="(unit.position.x * 54) + 2"
               [class.selected]="selectedUnit?.id === unit.id">
            <span class="unit-icon">
              @if (unit.type === 'settler') { üë®‚Äçüåæ }
              @else if (unit.type === 'warrior') { ‚öîÔ∏è }
              @else { üßç }
            </span>
          </div>
        }
      }
    </div>

    <!-- Info panel if a unit is selected -->
    <div class="info-panel" *ngIf="selectedUnit">
      <h3>{{ selectedUnit.name }}</h3>
      <p>Tipo: {{ selectedUnit.type }}</p>
      <p>Movimiento: {{ selectedUnit.movementPoints }}/{{ selectedUnit.maxMovementPoints }}</p>
      @if (selectedUnit.strength) {
        <p>Fuerza: {{ selectedUnit.strength }}</p>
      }

      <div class="action-buttons">
        <button *ngIf="selectedUnit.movementPoints > 0" (click)="clearSelection()">Cancelar</button>
        <button *ngIf="!selectedUnit.isFortified" (click)="fortifyUnit()">Fortificar</button>
        <button (click)="waitUnit()">Esperar</button>
      </div>
    </div>

    <!-- End turn button -->
    <button class="end-turn-button" (click)="finishTurn()">Terminar Turno</button>
  }
</div>
